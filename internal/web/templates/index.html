<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS Flux</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #64748b;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }
        
        /* Pagination Container Layout */
         .pagination-container {
             display: flex;
             justify-content: space-between;
             align-items: center;
             width: 100%;
         }
         
         .pagination-left {
             display: flex;
             align-items: center;
         }
         
         .pagination-right {
             display: flex;
             align-items: center;
         }
         
         /* Length Menu Styles - 左侧样式 */
         .dataTables_length {
             margin: 0 !important;
         }
         
         .dataTables_length label {
             display: flex !important;
             align-items: center !important;
             margin: 0 !important;
             font-size: 14px !important;
             font-weight: 400 !important;
             color: #6b7280 !important;
         }
         
         .dataTables_length select {
             margin-left: 8px !important;
             padding: 6px 24px 6px 12px !important;
             font-size: 14px !important;
             font-weight: 400 !important;
             color: #374151 !important;
             background: #ffffff !important;
             border: 1px solid #d1d5db !important;
             border-radius: 6px !important;
             transition: all 0.15s ease !important;
             appearance: none;
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
             background-position: right 6px center;
             background-repeat: no-repeat;
             background-size: 12px;
             min-width: 80px;
         }
         
         .dataTables_length select:focus {
             outline: none !important;
             border-color: #3b82f6 !important;
             box-shadow: 0 0 0 1px #3b82f6 !important;
         }
         
         .dataTables_length select:hover {
             border-color: #9ca3af !important;
         }
         
         /* Pagination Buttons - 右侧样式 */
         .dataTables_paginate {
             margin: 0 !important;
         }
         
         .dataTables_paginate .paginate_button {
             display: inline-flex !important;
             align-items: center !important;
             justify-content: center !important;
             padding: 6px 12px !important;
             margin: 0 2px !important;
             font-size: 14px !important;
             font-weight: 400 !important;
             color: #374151 !important;
             background: #ffffff !important;
             border: 1px solid #d1d5db !important;
             border-radius: 6px !important;
             text-decoration: none !important;
             transition: all 0.15s ease !important;
             min-width: 32px;
             height: 32px;
             cursor: pointer;
         }
         
         .dataTables_paginate .paginate_button:hover {
             color: #374151 !important;
             background: #f9fafb !important;
             border-color: #9ca3af !important;
         }
         
         .dataTables_paginate .paginate_button.current {
             color: #3b82f6 !important;
             background: #eff6ff !important;
             border-color: #3b82f6 !important;
             font-weight: 500 !important;
         }
         
         .dataTables_paginate .paginate_button.current:hover {
             color: #3b82f6 !important;
             background: #dbeafe !important;
             border-color: #3b82f6 !important;
         }
         
         .dataTables_paginate .paginate_button.disabled {
             color: #9ca3af !important;
             background: #ffffff !important;
             border-color: #e5e7eb !important;
             cursor: not-allowed !important;
         }
         
         .dataTables_paginate .paginate_button.disabled:hover {
             color: #9ca3af !important;
             background: #ffffff !important;
             border-color: #e5e7eb !important;
         }
         
         /* 省略号样式 */
         .dataTables_paginate .paginate_button.ellipsis {
             border: none !important;
             background: transparent !important;
             cursor: default !important;
         }
         
         .dataTables_paginate .paginate_button.ellipsis:hover {
             border: none !important;
             background: transparent !important;
         }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
             <div class="flex flex-col items-center justify-center text-center">
                 <div class="flex items-center space-x-3 mb-2">
                     <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                         <i class="fas fa-network-wired text-white text-lg"></i>
                     </div>
                     <h1 class="text-2xl font-bold text-slate-900">DNS Flux</h1>
                 </div>
                 <p class="text-sm text-slate-600">Real-time DNS Query Monitoring System</p>
                 <div class="flex items-center space-x-2 text-sm text-slate-600 mt-2">
                     <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                     <span>Live Monitoring</span>
                 </div>
             </div>
         </div>
     </header>

    <!-- Main Content -->
     <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
         <!-- Combined Search and Table Section -->
         <div class="bg-white rounded-xl shadow-sm border border-slate-200">
             <!-- Search Header -->
             <div class="px-6 py-4 border-b border-slate-200">
                 <div class="flex items-center justify-between mb-4">
                     <div class="flex items-center space-x-3">
                         <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                             <i class="fas fa-list text-blue-600 text-sm"></i>
                         </div>
                         <h2 class="text-lg font-semibold text-slate-900">DNS Query Records</h2>
                     </div>
                     <div class="text-sm text-gray-600" id="table-record-count">
                         <!-- 统计信息将显示在这里 -->
                     </div>
                 </div>
                 <div class="flex items-center space-x-4">
                     <div class="flex-1 relative">
                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                             <i class="fas fa-search text-slate-400"></i>
                         </div>
                         <input type="text" id="domainFilter" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition-colors duration-200 text-sm" placeholder="Enter domain to filter...">
                     </div>
                     <button type="button" onclick="applyFilter()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200 flex items-center space-x-2">
                         <i class="fas fa-filter text-sm"></i>
                         <span>Apply Filter</span>
                     </button>
                     <button type="button" id="clearFilterBtn" onclick="clearFilter()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium rounded-lg transition-colors duration-200 hidden" aria-label="Clear filter">
                         <i class="fas fa-times"></i>
                     </button>
                 </div>
             </div>
            
            <!-- Table Content -->
            <div class="overflow-hidden">
                <div class="overflow-x-auto">
                    <table id="dnsTable" class="w-full">
                        <thead class="bg-slate-50">
                             <tr>
                                 <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider border-b border-slate-200">Time</th>
                                 <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider border-b border-slate-200 w-1/6">Domain</th>
                                 <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider border-b border-slate-200">Type</th>
                                 <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider border-b border-slate-200 w-1/5">Result</th>
                                 <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider border-b border-slate-200">Process ID</th>
                                 <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider border-b border-slate-200">Process Name</th>
                                 <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider border-b border-slate-200">Process Path</th>
                             </tr>
                         </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 版权信息 -->
     <div class="flex items-center justify-between mt-6 px-6 py-4 bg-gray-50 border-t">
         <div class="flex-1"></div>
         <div class="text-sm text-gray-600 text-center">
             © 2024 DNSFlux. All rights reserved.
         </div>
         <div class="flex-1 flex justify-end">
             <div class="text-sm text-gray-600" id="copyright-info">
                 <!-- 统计信息将显示在这里 -->
             </div>
         </div>
     </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script>
    let table;
    let ws;

    function initWebSocket() {
        // 创建 WebSocket 连接
        ws = new WebSocket('ws://' + window.location.host + '/ws');

        ws.onmessage = function(event) {
            const newRecord = JSON.parse(event.data);
            // 将新记录添加到表格顶部
            table.row.add(newRecord).draw(false);
            updateRecordCount();
        };

        ws.onclose = function() {
            // 连接关闭后尝试重连
            setTimeout(initWebSocket, 2000);
        };
    }

    function updateRecordCount() {
        if (!table) {
            $('#table-record-count').text('Total 0 records');
            return;
        }
        const info = table.page.info();
        const totalRecords = info.recordsTotal;
        const filteredRecords = info.recordsDisplay;
        
        let countText;
        if (totalRecords === filteredRecords) {
            countText = `Total ${totalRecords} records`;
        } else {
            countText = `Showing ${filteredRecords} of ${totalRecords} records`;
        }
        
        // 更新表格标题区域的统计显示
        $('#table-record-count').text(countText);
    }

    $(document).ready(function() {
        table = $('#dnsTable').DataTable({
            order: [[0, 'desc']],
            pageLength: 50,
            lengthMenu: [[10, 25, 50, 100, -1], ['10 per page', '25 per page', '50 per page', '100 per page', 'Show all']],
            ordering: true,
            columnDefs: [
                { orderable: true, targets: '_all' }
            ],
            columns: [
                {
                    data: 'timestamp',
                    render: function(data) {
                        const date = new Date(data);
                        return `<div class="text-xs text-slate-500">${date.toLocaleDateString('zh-CN')}</div><div class="text-sm font-medium text-slate-900">${date.toLocaleTimeString('zh-CN')}</div>`;
                    },
                    className: 'px-6 py-4 whitespace-nowrap'
                },
                { 
                    data: 'queryName', 
                    render: function(data) {
                        return `<div class="text-sm font-medium text-slate-900 break-all">${data}</div>`;
                    },
                    className: 'px-6 py-4 w-1/6'
                },
                { 
                    data: 'queryType',
                    render: function(data) {
                        const colors = {
                            'A': 'bg-blue-100 text-blue-800',
                            'AAAA': 'bg-purple-100 text-purple-800',
                            'CNAME': 'bg-green-100 text-green-800',
                            'MX': 'bg-yellow-100 text-yellow-800',
                            'TXT': 'bg-gray-100 text-gray-800'
                        };
                        const colorClass = colors[data] || 'bg-gray-100 text-gray-800';
                        return `<span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${colorClass}">${data}</span>`;
                    },
                    className: 'px-6 py-4 whitespace-nowrap'
                },
                { 
                    data: 'queryResult',
                    render: function(data) {
                        return `<div class="text-sm text-slate-900 break-all">${data}</div>`;
                    },
                    className: 'px-6 py-4 w-1/5'
                },
                { 
                    data: 'processId',
                    render: function(data) {
                        return `<div class="text-sm font-mono text-slate-900">${data}</div>`;
                    },
                    className: 'px-6 py-4 whitespace-nowrap'
                },
                { 
                    data: 'processName',
                    render: function(data) {
                        return `<div class="text-sm font-medium text-slate-900">${data}</div>`;
                    },
                    className: 'px-6 py-4 whitespace-nowrap'
                },
                { 
                    data: 'processPath',
                    render: function(data) {
                        return `<div class="text-sm text-slate-600 break-all" title="${data}">${data}</div>`;
                    },
                    className: 'px-6 py-4 max-w-xs'
                },

            ],
            language: {
                lengthMenu: "Show _MENU_ entries",
                zeroRecords: `<div class="text-center py-12"><div class="w-16 h-16 mx-auto mb-4 bg-slate-100 rounded-full flex items-center justify-center"><i class="fas fa-inbox text-slate-400 text-xl"></i></div><div class="text-slate-500 font-medium">No DNS query records available</div><div class="text-slate-400 text-sm mt-1">DNS query records will appear here after monitoring starts</div></div>`,
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                infoEmpty: "No records",
                infoFiltered: "(filtered from _MAX_ total entries)",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                },
                search: "Search:",
                aria: {
                    sortAscending: ": activate to sort column ascending",
                    sortDescending: ": activate to sort column descending"
                }
            },
            dom: 't',
            drawCallback: function() {
                updateRecordCount();
                // 自定义分页样式
                $('.dataTables_paginate .paginate_button').addClass('px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 hover:bg-slate-50 transition-colors duration-200');
                $('.dataTables_paginate .paginate_button.current').addClass('bg-blue-600 text-white border-blue-600 hover:bg-blue-700');
                $('.dataTables_paginate .paginate_button.disabled').addClass('text-slate-400 cursor-not-allowed hover:bg-white');
                // 自定义长度选择器样式
                $('.dataTables_length select').addClass('px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500');
            }
        });
        
        // 初始化统计信息（即使无数据）
        updateRecordCount();
        // 初始化清空按钮可见性
        toggleClearButton();
        
        // 初始化 WebSocket 连接
        initWebSocket();
    });

    function applyFilter() {
        if (!table) return;
        const filterValue = $('#domainFilter').val();
        table.search(filterValue).draw();
        toggleClearButton();
    }

    function clearFilter() {
        if (!table) return;
        $('#domainFilter').val('');
        table.search('').draw();
        toggleClearButton();
    }

    function toggleClearButton() {
        const hasText = $('#domainFilter').val().trim().length > 0;
        $('#clearFilterBtn').toggleClass('hidden', !hasText);
    }

    // 输入时动态显示/隐藏清空按钮
    $('#domainFilter').on('input', function() {
        toggleClearButton();
    });

    // 回车键触发搜索
    $('#domainFilter').keypress(function(e) {
        if(e.which == 13) {
            applyFilter();
        }
    });
</script>
</body>
</html>